name: Update Reuters RSS

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 playwright

      - name: Install Playwright Chromium
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Install BotBrowser
        run: |
          LATEST=$(curl -s https://api.github.com/repos/MiddleSchoolStudent/BotBrowser/releases/latest \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'])")
          echo "BotBrowser latest release: $LATEST"

          ASSET_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/botbrowser-linux-x64"
          echo "Downloading: $ASSET_URL"
          curl -L "$ASSET_URL" -o botbrowser
          chmod +x botbrowser

          ./botbrowser --version || true

          echo "BOTBROWSER_PATH=$PWD/botbrowser" >> $GITHUB_ENV

      - name: Download BotBrowser bot-profile
        run: |
          LATEST=$(curl -s https://api.github.com/repos/MiddleSchoolStudent/BotBrowser/releases/latest \
            | python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'])")

          PROFILE_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/chrome_linux.enc.zip"
          echo "Downloading profile: $PROFILE_URL"
          curl -fL "$PROFILE_URL" -o botprofile.zip && unzip -o botprofile.zip || echo "Profile download skipped (not found for this release)"

          PROFILE_FILE=$(ls *.enc 2>/dev/null | head -1 || true)
          if [ -n "$PROFILE_FILE" ]; then
            echo "BOTBROWSER_PROFILE=$PWD/$PROFILE_FILE" >> $GITHUB_ENV
            echo "Using bot profile: $PROFILE_FILE"
          else
            echo "No profile file found â€” BotBrowser will run without a profile"
          fi

      - name: Start FlareSolverr
        run: |
          docker run -d \
            --name flaresolverr \
            -p 8191:8191 \
            -e LOG_LEVEL=info \
            ghcr.io/flaresolverr/flaresolverr:latest

      - name: Wait for FlareSolverr
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8191/v1 >/dev/null; then
              echo "FlareSolverr is up"
              break
            fi
            echo "Waiting... ($i)"
            sleep 3
          done

      - name: Run scraper
        env:
          BOTBROWSER_PATH: ${{ env.BOTBROWSER_PATH }}
          BOTBROWSER_PROFILE: ${{ env.BOTBROWSER_PROFILE }}
          BOTBROWSER_CDP_PORT: "9222"
        run: |
          python lau.py

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pau.xml opinin.html commentary.html

          git commit -m "Auto update RSS" || exit 0

          git pull --rebase origin main

          git push origin main