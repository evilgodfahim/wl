Name: Update Reuters RSS

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # needed to push changes back to the repo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 playwright

      - name: Install Playwright Chromium
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Install BotBrowser
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_RESPONSE=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/MiddleSchoolStudent/BotBrowser/releases/latest)

          LATEST=$(echo "$API_RESPONSE" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'tag_name' not in data:
    print('GitHub API error: ' + data.get('message', str(data)), file=sys.stderr)
    sys.exit(1)
print(data['tag_name'])
")
          echo "BotBrowser latest release: $LATEST"

          ASSET_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/botbrowser-linux-x64"
          echo "Downloading: $ASSET_URL"

          curl -fL \
            -H "Authorization: Bearer $GH_TOKEN" \
            "$ASSET_URL" -o botbrowser || {
              echo "Asset not found at $ASSET_URL"
              echo "Available assets for $LATEST:"
              echo "$API_RESPONSE" | python3 -c "
import sys, json
data = json.load(sys.stdin)
for a in data.get('assets', []):
    print(' -', a['name'])
"
              exit 1
            }

          chmod +x botbrowser
          ./botbrowser --version || true
          echo "BOTBROWSER_PATH=$PWD/botbrowser" >> $GITHUB_ENV

      - name: Download BotBrowser bot-profile
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST=$(curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/MiddleSchoolStudent/BotBrowser/releases/latest \
            | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'tag_name' not in data:
    print('GitHub API error: ' + data.get('message', str(data)), file=sys.stderr)
    sys.exit(1)
print(data['tag_name'])
")

          PROFILE_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/chrome_linux.enc.zip"
          echo "Downloading profile: $PROFILE_URL"

          curl -fL \
            -H "Authorization: Bearer $GH_TOKEN" \
            "$PROFILE_URL" -o botprofile.zip \
            && unzip -o botprofile.zip \
            || echo "Profile download skipped (not found for this release)"

          PROFILE_FILE=$(ls *.enc 2>/dev/null | head -1 || true)
          if [ -n "$PROFILE_FILE" ]; then
            echo "BOTBROWSER_PROFILE=$PWD/$PROFILE_FILE" >> $GITHUB_ENV
            echo "Using bot profile: $PROFILE_FILE"
          else
            echo "No profile file found â€” BotBrowser will run without a profile"
          fi

      - name: Start FlareSolverr
        run: |
          docker run -d \
            --name flaresolverr \
            -p 8191:8191 \
            -e LOG_LEVEL=info \
            ghcr.io/flaresolverr/flaresolverr:latest

      - name: Wait for FlareSolverr
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8191/v1 >/dev/null; then
              echo "FlareSolverr is up"
              break
            fi
            echo "Waiting... ($i)"
            sleep 3
          done

      - name: Run scraper
        env:
          BOTBROWSER_PATH: ${{ env.BOTBROWSER_PATH }}
          BOTBROWSER_PROFILE: ${{ env.BOTBROWSER_PROFILE }}
          BOTBROWSER_CDP_PORT: "9222"
        run: |
          python lau.py

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pau.xml opinin.html commentary.html apnews.html debug.log || true

          git diff --cached --quiet && echo "Nothing to commit" && exit 0

          git commit -m "Auto update RSS [$(date -u '+%Y-%m-%d %H:%M UTC')]"

          git pull --rebase origin main

          git push origin main
