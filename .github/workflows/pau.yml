name: Update Reuters RSS

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 playwright

      - name: Install Playwright Chromium
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Install BotBrowser
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch release info and show raw response for debugging
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/MiddleSchoolStudent/BotBrowser/releases/latest \
            > /tmp/bb_release.json

          echo "=== GitHub API raw response (first 500 chars) ==="
          head -c 500 /tmp/bb_release.json
          echo ""

          # Extract tag_name safely, fall back to listing all releases
          LATEST=$(python3 -c "
import json, sys
with open('/tmp/bb_release.json') as f:
    d = json.load(f)
if 'tag_name' in d:
    print(d['tag_name'])
else:
    print('API error: ' + str(d.get('message', d)), file=sys.stderr)
    sys.exit(1)
")

          # If latest release API failed, try listing all releases and pick first
          if [ $? -ne 0 ]; then
            echo "Falling back to /releases list..."
            curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/MiddleSchoolStudent/BotBrowser/releases?per_page=5" \
              > /tmp/bb_releases_list.json

            echo "=== Releases list response (first 500 chars) ==="
            head -c 500 /tmp/bb_releases_list.json
            echo ""

            LATEST=$(python3 -c "
import json, sys
with open('/tmp/bb_releases_list.json') as f:
    d = json.load(f)
if isinstance(d, list) and len(d) > 0 and 'tag_name' in d[0]:
    print(d[0]['tag_name'])
    # save first release as bb_release.json for later steps
    import json
    with open('/tmp/bb_release.json', 'w') as out:
        json.dump(d[0], out)
else:
    print('Could not determine latest release. Response: ' + str(d)[:200], file=sys.stderr)
    sys.exit(1)
")
          fi

          echo "BotBrowser latest release: $LATEST"
          echo "BOTBROWSER_TAG=$LATEST" >> $GITHUB_ENV

          # Show available assets
          echo "=== Available assets ==="
          python3 -c "import json; [print('-', a['name']) for a in json.load(open('/tmp/bb_release.json')).get('assets', [])]"

          ASSET_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/botbrowser-linux-x64"
          echo "Downloading: $ASSET_URL"

          curl -fL -H "Authorization: Bearer $GH_TOKEN" "$ASSET_URL" -o botbrowser || {
            echo "botbrowser-linux-x64 not found, trying botbrowser-linux..."
            ASSET_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/botbrowser-linux"
            curl -fL -H "Authorization: Bearer $GH_TOKEN" "$ASSET_URL" -o botbrowser || {
              echo "ERROR: Could not download BotBrowser binary. Check asset names above."
              exit 1
            }
          }

          chmod +x botbrowser
          ./botbrowser --version || true
          echo "BOTBROWSER_PATH=$PWD/botbrowser" >> $GITHUB_ENV

      - name: Download BotBrowser bot-profile
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST="${{ env.BOTBROWSER_TAG }}"

          PROFILE_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/chrome_linux.enc.zip"
          echo "Downloading profile: $PROFILE_URL"

          curl -fL -H "Authorization: Bearer $GH_TOKEN" "$PROFILE_URL" -o botprofile.zip \
            && unzip -o botprofile.zip \
            || echo "Profile download skipped (not found for this release)"

          PROFILE_FILE=$(ls *.enc 2>/dev/null | head -1 || true)
          if [ -n "$PROFILE_FILE" ]; then
            echo "BOTBROWSER_PROFILE=$PWD/$PROFILE_FILE" >> $GITHUB_ENV
            echo "Using bot profile: $PROFILE_FILE"
          else
            echo "No profile file found â€” BotBrowser will run without a profile"
          fi

      - name: Start FlareSolverr
        run: |
          docker run -d \
            --name flaresolverr \
            -p 8191:8191 \
            -e LOG_LEVEL=info \
            ghcr.io/flaresolverr/flaresolverr:latest

      - name: Wait for FlareSolverr
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8191/v1 >/dev/null; then
              echo "FlareSolverr is up"
              break
            fi
            echo "Waiting... ($i)"
            sleep 3
          done

      - name: Run scraper
        env:
          BOTBROWSER_PATH: ${{ env.BOTBROWSER_PATH }}
          BOTBROWSER_PROFILE: ${{ env.BOTBROWSER_PROFILE }}
          BOTBROWSER_CDP_PORT: "9222"
        run: |
          python lau.py

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add pau.xml opinin.html commentary.html apnews.html debug.log || true

          if git diff --cached --quiet; then
            echo "Nothing to commit"
            exit 0
          fi

          git commit -m "Auto update RSS [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          git pull --rebase origin main
          git push origin main