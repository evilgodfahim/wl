name: Update Reuters RSS

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set month for cache key
        run: echo "MONTH=$(date +%Y-%m)" >> $GITHUB_ENV

      - name: Cache BotBrowser user profile
        uses: actions/cache@v4
        with:
          path: ./botbrowser-profile
          key: botbrowser-profile-${{ env.MONTH }}
          restore-keys: botbrowser-profile-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 playwright

      - name: Install Playwright Chromium
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Install BotBrowser
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST=$(python3 get_bb_tag.py)
          echo "BotBrowser latest release: $LATEST"
          echo "BOTBROWSER_TAG=$LATEST" >> $GITHUB_ENV

          DEB_ASSET=$(grep "_x64.deb" /tmp/bb_assets.txt | head -1)
          echo "Using deb asset: $DEB_ASSET"

          if [ -z "$DEB_ASSET" ]; then
            echo "ERROR: no x64 .deb asset found:"
            cat /tmp/bb_assets.txt
            exit 1
          fi

          DEB_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/${DEB_ASSET}"
          echo "Downloading: $DEB_URL"
          curl -fL -H "Authorization: Bearer $GH_TOKEN" "$DEB_URL" -o botbrowser.deb
          sudo dpkg -i botbrowser.deb || sudo apt-get install -f -y

          # Try known install locations in order
          BB_BIN=""
          for candidate in \
            /usr/bin/chromium-browser-stable \
            /usr/bin/chromium-browser \
            /opt/chromium.org/chromium/chromium \
            /usr/bin/botbrowser; do
            if [ -f "$candidate" ] && [ -x "$candidate" ]; then
              BB_BIN="$candidate"
              break
            fi
          done

          if [ -z "$BB_BIN" ]; then
            echo "ERROR: could not find installed browser binary"
            exit 1
          fi

          echo "BotBrowser binary: $BB_BIN"
          "$BB_BIN" --version || true
          echo "BOTBROWSER_PATH=$BB_BIN" >> $GITHUB_ENV

      - name: Download BotBrowser bot-profile
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST="${{ env.BOTBROWSER_TAG }}"

          PROFILE_ASSET=$(grep -i "linux.*enc.zip\|linux.*profile" /tmp/bb_assets.txt | head -1 || true)

          if [ -z "$PROFILE_ASSET" ]; then
            echo "No linux profile asset found — skipping"
          else
            PROFILE_URL="https://github.com/MiddleSchoolStudent/BotBrowser/releases/download/${LATEST}/${PROFILE_ASSET}"
            echo "Downloading profile: $PROFILE_URL"
            curl -fL -H "Authorization: Bearer $GH_TOKEN" "$PROFILE_URL" -o botprofile.zip \
              && unzip -o botprofile.zip \
              || echo "Profile download failed — continuing without profile"
          fi

          PROFILE_FILE=$(ls *.enc 2>/dev/null | head -1 || true)
          if [ -n "$PROFILE_FILE" ]; then
            echo "BOTBROWSER_PROFILE=$PWD/$PROFILE_FILE" >> $GITHUB_ENV
            echo "Using bot profile: $PROFILE_FILE"
          else
            echo "No profile file found — BotBrowser will run without a profile"
          fi

      - name: Start FlareSolverr
        run: |
          docker run -d \
            --name flaresolverr \
            -p 8191:8191 \
            -e LOG_LEVEL=info \
            ghcr.io/flaresolverr/flaresolverr:latest

      - name: Wait for FlareSolverr
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8191/v1 >/dev/null; then
              echo "FlareSolverr is up"
              break
            fi
            echo "Waiting... ($i)"
            sleep 3
          done

      - name: Run scraper
        env:
          BOTBROWSER_PATH: ${{ env.BOTBROWSER_PATH }}
          BOTBROWSER_PROFILE: ${{ env.BOTBROWSER_PROFILE }}
          BOTBROWSER_CDP_PORT: "9222"
        run: |
          python lau.py

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add *.xml opinin.html commentary.html apnews.html debug.log || true

          if git diff --cached --quiet; then
            echo "Nothing to commit"
            exit 0
          fi

          git commit -m "Auto update RSS [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          git pull --rebase origin main
          git push origin main